<!doctype html><html lang=en-us prefix="og: https://ogp.me/ns#"><meta charset=utf-8><meta name=color-scheme content="light dark"><meta name=viewport content="initial-scale=1,minimum-scale=1,width=device-width"><meta name=description content="A guide to get Whonix running on Hyper-V."><title>Hacking Whonix onto Hyper-V</title><meta property="og:type" content="article"><meta property="og:title" content="Hacking Whonix onto Hyper-V"><meta property="article:published_time" content="2021-06-05T00:00:00+00:00"><meta property="article:modified_time" content="2021-06-05T00:00:00+00:00"><meta property="article:section" content="blog"><meta property="og:image" content="https://qua3k.github.io/ogp.png"><meta property="og:image:alt" content="a gravatar identicon"><meta property="og:site_name" content="segmentation fault"><meta property="og:url" content="https://qua3k.github.io/guides/whonix/"><link href=/css/main.min.css rel=stylesheet><link href=/css/highlight.min.css rel=stylesheet><link rel=icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/favicon.svg><link rel=mask-icon color=#dd8c79 href=/mask-icon.svg><header><a href=/>segmentation fault</a></header><main><span class=site-metadata><time datetime=2021-06-05>05 Jun 2021</time></span><h1 class=title>Hacking Whonix onto Hyper-V</h1><p class=description>A guide to get Whonix running on Hyper-V.</p><p>This guide aims to get the Whonixâ„¢ operating system running on Hyper-V. This
guide does not expect Virtualbox specific features such as guest additions to
work and does not expend any effort to make them work.</p><nav><h2 id=#table-of-contents>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#prerequisites>Prerequisites</a><ul><li><a href=#acquire-the-necessary-tools>Acquire the necessary tools</a></li><li><a href=#verify-the-signature>Verify the signature</a></li><li><a href=#extract-the-archive>Extract the archive</a></li><li><a href=#convert-the-disks>Convert the disks</a></li></ul></li><li><a href=#virtual-machine-setup>Virtual Machine Setup</a><ul><li><a href=#set-up-networking>Set up networking</a></li><li><a href=#create-virtual-machines>Create virtual machines</a></li></ul></li><li><a href=#post-boot-configuration>Post-boot configuration</a></li><li><a href=#round-2-working-with-efi>Round 2: Working with EFI</a><ul><li><a href=#install-grub-efi>Install grub-efi</a></li><li><a href=#partitioning>Partitioning</a></li></ul></li><li><a href=#secure-boot>Secure Boot</a></li><li><a href=#see-also>See also</a></li></ul></nav></nav><h2 id=prerequisites>Prerequisites</h2><h3 id=acquire-the-necessary-tools>Acquire the necessary tools</h3><ul><li><a href=https://www.whonix.org/wiki/VirtualBox>Whonix for VirtualBox</a></li><li><a href=https://www.virtualbox.org/wiki/Downloads>VirtualBox for Windows</a></li></ul><h3 id=verify-the-signature>Verify the signature</h3><p>See the <a href=https://www.whonix.org/wiki/Verify_the_Whonix_images>Whonix wiki</a>.</p><h3 id=extract-the-archive>Extract the archive</h3><p>Use <code>tar</code> or another archive utility of choice to extract the <code>ova</code> archive,
producing two <code>vmdk</code> virtual disks.</p><h3 id=convert-the-disks>Convert the disks</h3><p>Convert both virtual disks to <code>vhd</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>VBoxManage</span><span class=p>.</span><span class=n>exe</span> <span class=n>clonehd</span> <span class=n>source</span><span class=p>.</span><span class=n>vmdk</span> <span class=n>target</span><span class=p>.</span><span class=n>vhd</span> <span class=p>-</span><span class=n>-format</span> <span class=n>vhd</span>
</span></span></code></pre></div><h2 id=virtual-machine-setup>Virtual Machine Setup</h2><h3 id=set-up-networking>Set up networking</h3><ul><li><p>Create an internal switch named WhonixGateway and find its
<a href=https://docs.microsoft.com/en-us/virtualization/hyper-v-on-windows/user-guide/setup-nat-network#create-a-nat-virtual-network>interface index</a>.</p><ul><li><p>Create the NAT gateway with the previously mentioned interface index</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>New-NetIPAddress</span> <span class=n>-IPAddress</span> <span class=n>10</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>2</span> <span class=n>-PrefixLength</span> <span class=n>24</span> <span class=n>-InterfaceIndex</span> <span class=p>&lt;</span><span class=n>ifIndex</span><span class=p>&gt;</span>
</span></span></code></pre></div></li><li><p>Configure the NAT Network&rsquo;s name and NAT subnet prefix</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>New-NetNat</span> <span class=n>-Name</span> <span class=n>Gateway</span> <span class=n>-InternalIPInterfaceAddressPrefix</span> <span class=n>10</span><span class=p>.</span><span class=n>0</span><span class=p>.</span><span class=n>2</span><span class=p>.</span><span class=n>0</span><span class=p>/</span><span class=n>24</span>
</span></span></code></pre></div></li></ul></li><li><p>Create a private switch, used to connect Whonix-Gateway to Whonix-Workstation.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>New-VMSwitch</span> <span class=n>-SwitchName</span> <span class=n>WhonixPrivate</span> <span class=n>-SwitchType</span> <span class=n>Private</span>
</span></span></code></pre></div></li></ul><h3 id=create-virtual-machines>Create virtual machines</h3><p>Whonix still uses GRUB&rsquo;s BIOS payload. It isn&rsquo;t UEFI compatible and doesn&rsquo;t run
in Hyper-V&rsquo;s &ldquo;Gen 2&rdquo; VMs, which bring various security improvements. However,
you can attempt to run Whonix in &ldquo;Gen 2&rdquo; VMs here.</p><ul><li>Create two virtual machines and one virtual disk (<code>whonix-xxxx-disk00x.vhd</code>)
to each.</li><li>Create a virtual network adapter on the Whonix-Gateway VM connecting to the
&ldquo;WhonixGateway&rdquo; virtual switch.</li><li>Create virtual network adapters on both VMs connecting to the &ldquo;WhonixPrivate&rdquo;
virtual switch.</li></ul><h2 id=post-boot-configuration>Post-boot configuration</h2><p>We need to load some kernel modules to get networking working on Whonix. See
<a href=https://blog.jitdor.com/2020/02/08/enable-hyper-v-integration-services-for-your-ubuntu-guest-vms/>this link</a>
for more info.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>printf</span> <span class=s2>&#34;hv_utils \nhv_vmbus \nhv_storvsc \nhv_blksvc \nhv_netvsc&#34;</span> &gt;&gt; /etc/initramfs-tools/modules
</span></span><span class=line><span class=cl>update-initramfs -u
</span></span></code></pre></div><h2 id=round-2-working-with-efi>Round 2: Working with EFI</h2><p>Turns out EFI is relatively simple; install <code>grub-efi</code> and convert the partition
table to GPT. This next section is for the people who need it.</p><blockquote><p>Generation 2 virtual machines only support <code>.vhdx</code> disks. You should convert
the disks within the Hyper-V Manager UI or with the PowerShell cmdlet
<code>Convert-VHD</code>.</p></blockquote><h3 id=install-grub-efi>Install grub-efi</h3><p>Boot up your existing Generation 1 virtual machine and install <code>grub-efi-amd64</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>apt update
</span></span><span class=line><span class=cl>apt install grub-efi-amd64
</span></span><span class=line><span class=cl>apt purge grub-pc-bin
</span></span></code></pre></div><h3 id=partitioning>Partitioning</h3><ul><li><p>Resize /dev/sda1 to create some free space for the EFi system partition with <code>cfdisk /dev/sda</code>.</p></li><li><p>Use <code>gdisk /dev/sda</code> to convert the partition table to GPT and create the ESP on <code>/dev/sda2</code>.</p></li><li><p>Format the EFI partition</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkfs.fat -F <span class=m>32</span> /dev/sda2
</span></span></code></pre></div></li><li><p>Mount partitions</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mount /dev/sda1 /mnt
</span></span><span class=line><span class=cl>mkdir -p /mnt/boot/efi
</span></span><span class=line><span class=cl>mount /dev/sda2 /mnt/boot/efi
</span></span><span class=line><span class=cl><span class=k>for</span> d in dev proc run sys<span class=p>;</span> <span class=k>do</span> sudo mount -B /<span class=nv>$d</span> /mnt/<span class=nv>$d</span><span class=p>;</span> <span class=k>done</span>
</span></span></code></pre></div></li><li><p>Finish the GRUB install</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>chroot /mnt
</span></span><span class=line><span class=cl>grub-install --target<span class=o>=</span>x86_64-efi --efi-directory<span class=o>=</span>/boot/efi --bootloader-id<span class=o>=</span>DEBIAN
</span></span><span class=line><span class=cl>grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div></li><li><p>Unmount and reboot</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>umount -R /mnt
</span></span><span class=line><span class=cl>reboot
</span></span></code></pre></div></li></ul><h2 id=secure-boot>Secure Boot</h2><p>Debian&rsquo;s <code>grub-efi</code> package comes with <code>shim</code> out of the box signed by Microsoft&rsquo;s third
party UEFI CA; it is up to the user to enable it in VM settings.</p><p>Do keep in mind this is mainly theater, as userspace components are not verified.</p><h2 id=see-also>See also</h2><ul><li><a href=https://forums.whonix.org>https://forums.whonix.org</a></li></ul></main>